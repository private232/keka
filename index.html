<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; margin-bottom: 25px; }
        .filters { margin-bottom: 25px; display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; }
        .filters .filter-group { display: flex; align-items: center; gap: 10px; }
        .filters label { font-size: 1.1em; font-weight: 600; }
        .filters select, .filters input[type="search"] { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Cairo', sans-serif; font-size: 1em; }
        .filters input[type="search"] { width: 250px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; font-size: 16px; vertical-align: middle; }
        thead { background-color: #007bff; color: #fff; font-weight: 700; }
        tbody tr:nth-child(even) { background-color: #f2f2f2; }
        
        /* ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
        .action-btn { background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: transform 0.2s; }
        .delete-btn { color: #dc3545; }
        .edit-btn { color: #007bff; }
        .save-btn { color: #28a745; }
        .action-btn:hover { transform: scale(1.2); }
        .edit-date-input { padding: 6px; border: 1px solid #007bff; border-radius: 4px; font-family: 'Cairo', sans-serif; font-size: 15px; text-align: center; width: 180px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h1>
        <div class="filters">
            <div class="filter-group">
                <label for="searchInput">ğŸ” Ø¨Ø­Ø«:</label>
                <input type="search" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ...">
            </div>
            <div class="filter-group">
                <label for="cityFilter">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
                <select id="cityFilter"></select>
            </div>
        </div>

        <p id="total-count" style="font-weight: bold; font-size: 1.2em;"></p>
        <p id="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        
        <table id="studentsTable" style="display:none;">
            <thead>
                <tr>
                    <th>Ù…</th>
                    <th>Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ</th>
                    <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, get, remove, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYJA6Geof8vMubrSrNhL1yEoI4W-ofWhQ",
            authDomain: "academy-9b03c.firebaseapp.com",
            databaseURL: "https://academy-9b03c-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "academy-9b03c",
            storageBucket: "academy-9b03c.firebasestorage.app",
            messagingSenderId: "929195836341",
            appId: "1:929195836341:web:ec8250202f73c0cf528ffc"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const governorates = ["Ø§Ù„ÙƒÙ„", "Ø³ÙˆÙ‡Ø§Ø¬", "Ù‚Ù†Ø§", "Ø£Ø³ÙŠÙˆØ·", "Ø§Ù„Ù…Ù†ÙŠØ§", "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ", "Ø§Ù„ÙÙŠÙˆÙ…", "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø£Ø³ÙˆØ§Ù†", "Ø§Ù„Ø£Ù‚ØµØ±", "Ø§Ù„ØºØ±Ø¯Ù‚Ø©"];
        let allStudentsData = [];

        const loadingMessage = document.getElementById('loading');
        const studentsTable = document.getElementById('studentsTable');
        const tableBody = document.getElementById('tableBody');
        const totalCount = document.getElementById('total-count');
        const cityFilter = document.getElementById('cityFilter');
        const searchInput = document.getElementById('searchInput');

        async function updateStudentDate(studentKey, newDate) {
            try {
                const studentRef = ref(db, `students/${studentKey}`);
                await update(studentRef, { date: newDate });
                const studentIndex = allStudentsData.findIndex(s => s.key === studentKey);
                if (studentIndex > -1) {
                    allStudentsData[studentIndex].date = newDate;
                }
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­.");
                renderTable();
            } catch (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", error);
            }
        }
        
        async function deleteStudent(studentKey, studentName) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}ØŸ`)) return;
            try {
                await remove(ref(db, `students/${studentKey}`));
                allStudentsData = allStudentsData.filter(student => student.key !== studentKey);
                renderTable();
                alert(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentName} Ø¨Ù†Ø¬Ø§Ø­.`);
            } catch (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø°Ù.");
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", error);
            }
        }
        
        function renderTable() {
            const selectedCity = cityFilter.value;
            const searchQuery = searchInput.value.toLowerCase();
            tableBody.innerHTML = '';
            
            let filteredByCity = allStudentsData;
            if (selectedCity !== 'Ø§Ù„ÙƒÙ„') {
                filteredByCity = allStudentsData.filter(student => student.city === selectedCity);
            }

            const studentsToDisplay = filteredByCity.filter(student => {
                const name = student.name ? student.name.toLowerCase() : '';
                const nationalId = student.nationalId || '';
                return name.includes(searchQuery) || nationalId.includes(searchQuery);
            });
            
            totalCount.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ÙŠÙ†: ${studentsToDisplay.length}`;

            if (studentsToDisplay.length > 0) {
                studentsTable.style.display = 'table';
                studentsToDisplay.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${student.name || ''}</td>
                        <td>${student.nationalId || ''}</td>
                        <td>${student.phone || ''}</td>
                        <td data-key="${student.key}">
                            <span class="date-text">${student.date || ''}</span>
                        </td>
                        <td>
                            <button class="action-btn edit-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®">âœï¸</button>
                            <button class="action-btn delete-btn" title="Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨">ğŸ—‘ï¸</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                studentsTable.style.display = 'none';
            }
        }

        async function initialize() {
            loadingMessage.style.display = 'block';
            studentsTable.style.display = 'none';
            cityFilter.innerHTML = governorates.map(g => `<option value="${g}">${g}</option>`).join('');
            
            // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ÙŠØ§ ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ---
            cityFilter.value = 'Ø§Ù„Ù…Ù†ÙŠØ§';
            
            try {
                const snapshot = await get(ref(db, 'students'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    allStudentsData = [];
                    for (const key in data) { allStudentsData.push({ key, ...data[key] }); }
                }
                renderTable();
            } catch (error) { console.error("Error loading data:", error); }
            loadingMessage.style.display = 'none';
        }

        cityFilter.addEventListener('change', renderTable);
        searchInput.addEventListener('input', renderTable);

        tableBody.addEventListener('click', (event) => {
            const target = event.target;
            const row = target.closest('tr');
            if (!row) return;

            const studentKey = row.querySelector('td[data-key]').dataset.key;
            const student = allStudentsData.find(s => s.key === studentKey);
            const dateCell = row.querySelector('td[data-key]');

            if (target.classList.contains('delete-btn')) {
                deleteStudent(student.key, student.name);
            }
            else if (target.classList.contains('edit-btn')) {
                dateCell.innerHTML = `<input type="text" class="edit-date-input" value="${student.date || ''}">`;
                target.outerHTML = `<button class="action-btn save-btn" title="Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ®">ğŸ’¾</button>`;
            }
            else if (target.classList.contains('save-btn')) {
                const newDate = dateCell.querySelector('.edit-date-input').value;
                updateStudentDate(student.key, newDate);
            }
        });

        initialize();
    </script>
</body>
</html>
