<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <style>
        body { transition: opacity ease-in 0.2s; }
        body[unresolved] { opacity: 0; display: block; overflow: hidden; position: relative; }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تأكيد الحجز - الأكاديمية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        @font-face { font-family: "Fonty"; src: url("Fonty.ttf") format("truetype"); }
        body { margin:0; font-family:"Cairo",sans-serif; color:#fff; text-align:center; overflow-x:hidden; background:#000; }
        iframe { position: fixed; top: 50%; left: 50%; width: 120vw; height: 120vh; transform: translate(-50%, -50%); z-index: -2; object-fit: cover; border: none; pointer-events: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); z-index: -1; }
        .header { position:fixed; top:0; right:0; left:0; display:flex; justify-content:space-between; align-items:center; padding:15px 30px; background:rgba(0,0,0,0.6); z-index:1000; }
        .header img { height:90px; }
        .header h1 { color:#ffcc00; font-size:22px; font-weight:800; margin:0; font-family:"Fonty",sans-serif; }
        .form-container { background:rgba(0,0,0,0.6); padding:20px; border-radius:15px; width:95%; max-width:480px; margin:160px auto 80px; box-shadow:0 0 15px rgba(0,0,0,0.7); }
        h2 { font-size:22px; color:#ffcc00; margin-bottom:12px; font-family:"Fonty",sans-serif; }
        input, select { width:95%; padding:12px; margin:8px 0; border:none; border-radius:8px; font-size:16px; background:#fff; color:#000; box-sizing:border-box; }
        button { background:#ffcc00; color:#000; font-weight:bold; border:none; padding:12px 16px; border-radius:10px; cursor:pointer; transition:0.2s; font-size:17px; width:95%; margin-top:12px; position: relative; }
        button:disabled { opacity:0.7; cursor:not-allowed; }
        button.loading::after { content: ""; position: absolute; right: 15px; top: 50%; width: 18px; height: 18px; border: 3px solid #000; border-top: 3px solid transparent; border-radius: 50%; transform: translateY(-50%); animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: translateY(-50%) rotate(0deg); } to { transform: translateY(-50%) rotate(360deg); } }
        .socials { margin-top:16px; }
        .socials img { width:40px; margin:0 6px; cursor:pointer; }
    </style>
</head>
<body>

<iframe src="https://www.youtube.com/embed/ftVVLJc9F_Y?autoplay=1&amp;mute=1&amp;loop=1&amp;playlist=ftVVLJc9F_Y&amp;controls=0&amp;showinfo=0&amp;modestbranding=1&amp;rel=0&amp;vq=hd1080" allow="autoplay; fullscreen"></iframe>
<div class="overlay"></div>

<div class="header">
  <h1>الدكتور في الفيزياء</h1>
  <img src="Logo.png" alt="Logo">
</div>

<div class="form-container" aria-live="polite">
  <h2>🧾 احجز مكانك في جولة الدكتور</h2>
  <input type="text" id="name" placeholder="الاسم رباعي" autocomplete="name">
  <input type="text" id="nid" placeholder="الرقم القومي (14 رقم)" inputmode="numeric" maxlength="14">
  <input type="text" id="phone" placeholder="رقم الهاتف (11 رقم)" inputmode="tel" maxlength="11">
  <select id="grade">
    <option value="">اختر الصف الدراسي</option>
    <option value="الصف الثالث الثانوي">الصف الثالث الثانوي</option>
    <option value="الصف الثاني الثانوي">الصف الثاني الثانوي</option>
  </select>
  <select id="city">
    <option value="">اختر المحافظة</option>
    <option value="سوهاج">سوهاج</option> <option value="قنا">قنا</option> <option value="أسيوط">أسيوط</option> <option value="المنيا">المنيا</option> <option value="بني سويف">بني سويف</option> <option value="الفيوم">الفيوم</option> <option value="القاهرة">القاهرة</option> <option value="أسوان">أسوان</option> <option value="الأقصر">الأقصر</option> <option value="الغردقة">الغردقة</option>
  </select>
  <select id="timeField" style="display:none;">
    <option value="">موعد الجولة</option>
  </select>
  <button id="submitBtn" disabled>تأكيد الحجز</button>
  <div class="socials" aria-hidden="true">
    <img src="facebook.png" onclick="window.open('https://www.facebook.com/share/178pNbQt3u/?mibextid=wwXIfr','_blank')">
    <img src="tiktok.png" onclick="window.open('https://www.tiktok.com/@dr.keroles.physics','_blank')">
    <img src="google-play.png" onclick="window.open('https://play.google.com/store/apps/details?id=com.narmar.thedoctor','_blank')">
    <img src="youtube.png" onclick="window.open('https://www.youtube.com/@doctor.physics','_blank')">
  </div>
  <p class="note">📞 الدعم الفني: 19127</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getDatabase, ref, get, push, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYJA6Geof8vMubrSrNhL1yEoI4W-ofWhQ",
    authDomain: "academy-9b03c.firebaseapp.com",
    databaseURL: "https://academy-9b03c-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "academy-9b03c",
    storageBucket: "academy-9b03c.firebasestorage.app",
    messagingSenderId: "929195836341",
    appId: "1:929195836341:web:ec8250202f73c0cf528ffc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const studentsRef = ref(db, "students");

  const nameEl = document.getElementById("name");
  const nidEl = document.getElementById("nid");
  const phoneEl = document.getElementById("phone");
  const cityEl = document.getElementById("city");
  const gradeEl = document.getElementById("grade");
  const timeField = document.getElementById("timeField");
  const submitBtn = document.getElementById("submitBtn");

  const cityTimes = {  
    "قنا": ["من الساعة 9:00 صباحًا"],  
    "سوهاج": ["من الساعة 1:00 ظهرًا"],  
    "أسيوط": ["من الساعة 1:00 ظهرًا"],
    "المنيا": ["من الساعة 10:00 صباحًا"],
    "بني سويف": ["من الساعة 10:00 صباحًا"],
    "الفيوم": ["من الساعة 10:00 صباحًا"],
    "القاهرة": ["من الساعة 9:00 صباحًا"],
    "أسوان": ["من الساعة 10:00 صباحًا"],
    "الأقصر": ["من الساعة 9:00 صباحًا"],
    "الغردقة": ["من الساعة 10:00 صباحًا"]
  };

  function updateTimeField() {
    const city = cityEl.value;
    const grade = gradeEl.value;
    if (grade === "الصف الثالث الثانوي" && cityTimes[city]) {
      timeField.style.display = "block";
      timeField.innerHTML = `<option value="">موعد الجولة</option>` + cityTimes[city].map(time => `<option>${time}</option>`).join("");
    } else {
      timeField.style.display = "none";
      timeField.innerHTML = "";
    }
  }

  cityEl.addEventListener("change", updateTimeField);
  gradeEl.addEventListener("change", updateTimeField);

  function validateBasicFields() {
    const name = nameEl.value.trim();
    const nid = nidEl.value.trim();
    const phone = phoneEl.value.trim();
    const city = cityEl.value;
    const grade = gradeEl.value;
    if (!name || !nid || !phone || !city || !grade) return false;
    if (name.split(" ").length < 4) return false;
    if (!/^\d{14}$/.test(nid)) return false;
    if (!/^\d{11}$/.test(phone)) return false;
    return true;
  }

  function updateSubmitState() {
    submitBtn.disabled = !validateBasicFields();
  }

  [nameEl, nidEl, phoneEl, cityEl, gradeEl].forEach(el => {
    el.addEventListener("input", updateSubmitState);
    el.addEventListener("change", updateSubmitState);
  });

  submitBtn.addEventListener("click", async () => {
    if (!validateBasicFields()) {  
      alert("⚠️ من فضلك املأ جميع البيانات بشكل صحيح.");  
      return;  
    }

    submitBtn.disabled = true;
    submitBtn.classList.add("loading");
    submitBtn.innerText = "جاري التأكيد...";

    try {
      const name = nameEl.value.trim();
      const nid = nidEl.value.trim();
      const phone = phoneEl.value.trim();
      const city = cityEl.value;
      const grade = gradeEl.value;
      const time = timeField.value || "غير محدد";

      if (grade === "الصف الثاني الثانوي") {
        window.location.href = "waiting.html";
        return;
      }

      const snapshot = await get(studentsRef);
      const data = snapshot.val() || {};
      const students = Object.values(data);

      const existingStudent = students.find(s => s.nationalId === nid);
      if (existingStudent) {
        alert(`⚠️ هذا الطالب مسجل بالفعل في محافظة (${existingStudent.city}) ولا يمكن التسجيل مرة أخرى.`);
        submitBtn.disabled = false;
        submitBtn.classList.remove("loading");
        submitBtn.innerText = "تأكيد الحجز";
        return;
      }

      // --- تم حذف الجزء الخاص بالتحقق من الحد الأقصى (الลิمิต) من هنا ---

      await set(push(studentsRef), {
        name,
        nationalId: nid,
        phone,
        city,
        grade,
        time,
        date: new Date().toISOString() // حفظ التاريخ بالصيغة القياسية
      });

      window.location.href = `confirm.html?name=${encodeURIComponent(name)}&nid=${encodeURIComponent(nid)}&city=${encodeURIComponent(city)}`;

    } catch (error) {
      alert("حدث خطأ أثناء الحجز. حاول مرة أخرى.");
      console.error(error);
      submitBtn.disabled = false;
      submitBtn.classList.remove("loading");
      submitBtn.innerText = "تأكيد الحجز";
    }
  });

  updateSubmitState();
</script>

</body>
</html>