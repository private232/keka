<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <style>
        body { transition: opacity ease-in 0.2s; }
        body[unresolved] { opacity: 0; display: block; overflow: hidden; position: relative; }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² - Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        @font-face { font-family: "Fonty"; src: url("Fonty.ttf") format("truetype"); }
        body { margin:0; font-family:"Cairo",sans-serif; color:#fff; text-align:center; overflow-x:hidden; background:#000; }
        iframe { position: fixed; top: 50%; left: 50%; width: 120vw; height: 120vh; transform: translate(-50%, -50%); z-index: -2; object-fit: cover; border: none; pointer-events: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); z-index: -1; }
        .header { position:fixed; top:0; right:0; left:0; display:flex; justify-content:space-between; align-items:center; padding:15px 30px; background:rgba(0,0,0,0.6); z-index:1000; }
        .header img { height:90px; }
        .header h1 { color:#ffcc00; font-size:22px; font-weight:800; margin:0; font-family:"Fonty",sans-serif; }
        .form-container { background:rgba(0,0,0,0.6); padding:20px; border-radius:15px; width:95%; max-width:480px; margin:160px auto 80px; box-shadow:0 0 15px rgba(0,0,0,0.7); }
        h2 { font-size:22px; color:#ffcc00; margin-bottom:12px; font-family:"Fonty",sans-serif; }
        input, select { width:95%; padding:12px; margin:8px 0; border:none; border-radius:8px; font-size:16px; background:#fff; color:#000; box-sizing:border-box; }
        button { background:#ffcc00; color:#000; font-weight:bold; border:none; padding:12px 16px; border-radius:10px; cursor:pointer; transition:0.2s; font-size:17px; width:95%; margin-top:12px; position: relative; }
        button:disabled { opacity:0.7; cursor:not-allowed; }
        button.loading::after { content: ""; position: absolute; right: 15px; top: 50%; width: 18px; height: 18px; border: 3px solid #000; border-top: 3px solid transparent; border-radius: 50%; transform: translateY(-50%); animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: translateY(-50%) rotate(0deg); } to { transform: translateY(-50%) rotate(360deg); } }
        .socials { margin-top:16px; }
        .socials img { width:40px; margin:0 6px; cursor:pointer; }
    </style>
</head>
<body>

<iframe src="https://www.youtube.com/embed/ftVVLJc9F_Y?autoplay=1&amp;mute=1&amp;loop=1&amp;playlist=ftVVLJc9F_Y&amp;controls=0&amp;showinfo=0&amp;modestbranding=1&amp;rel=0&amp;vq=hd1080" allow="autoplay; fullscreen"></iframe>
<div class="overlay"></div>

<div class="header">
  <h1>Ø§Ù„Ø¯ÙƒØªÙˆØ± ÙÙŠ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</h1>
  <img src="Logo.png" alt="Logo">
</div>

<div class="form-container" aria-live="polite">
  <h2>ğŸ§¾ Ø§Ø­Ø¬Ø² Ù…ÙƒØ§Ù†Ùƒ ÙÙŠ Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¯ÙƒØªÙˆØ±</h2>
  <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ" autocomplete="name">
  <input type="text" id="nid" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)" inputmode="numeric" maxlength="14">
  <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)" inputmode="tel" maxlength="11">
  <select id="grade">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</option>
    <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
    <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
  </select>
  <select id="city">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
    <option value="Ø³ÙˆÙ‡Ø§Ø¬">Ø³ÙˆÙ‡Ø§Ø¬</option> <option value="Ù‚Ù†Ø§">Ù‚Ù†Ø§</option> <option value="Ø£Ø³ÙŠÙˆØ·">Ø£Ø³ÙŠÙˆØ·</option> <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option> <option value="Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ">Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option> <option value="Ø§Ù„ÙÙŠÙˆÙ…">Ø§Ù„ÙÙŠÙˆÙ…</option> <option value="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option> <option value="Ø£Ø³ÙˆØ§Ù†">Ø£Ø³ÙˆØ§Ù†</option> <option value="Ø§Ù„Ø£Ù‚ØµØ±">Ø§Ù„Ø£Ù‚ØµØ±</option> <option value="Ø§Ù„ØºØ±Ø¯Ù‚Ø©">Ø§Ù„ØºØ±Ø¯Ù‚Ø©</option>
  </select>
  <select id="timeField" style="display:none;">
    <option value="">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø©</option>
  </select>
  <button id="submitBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
  <div class="socials" aria-hidden="true">
    <img src="facebook.png" onclick="window.open('https://www.facebook.com/share/178pNbQt3u/?mibextid=wwXIfr','_blank')">
    <img src="tiktok.png" onclick="window.open('https://www.tiktok.com/@dr.keroles.physics','_blank')">
    <img src="google-play.png" onclick="window.open('https://play.google.com/store/apps/details?id=com.narmar.thedoctor','_blank')">
    <img src="youtube.png" onclick="window.open('https://www.youtube.com/@doctor.physics','_blank')">
  </div>
  <p class="note">ğŸ“ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ: 19127</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getDatabase, ref, get, push, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYJA6Geof8vMubrSrNhL1yEoI4W-ofWhQ",
    authDomain: "academy-9b03c.firebaseapp.com",
    databaseURL: "https://academy-9b03c-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "academy-9b03c",
    storageBucket: "academy-9b03c.firebasestorage.app",
    messagingSenderId: "929195836341",
    appId: "1:929195836341:web:ec8250202f73c0cf528ffc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const studentsRef = ref(db, "students");

  const nameEl = document.getElementById("name");
  const nidEl = document.getElementById("nid");
  const phoneEl = document.getElementById("phone");
  const cityEl = document.getElementById("city");
  const gradeEl = document.getElementById("grade");
  const timeField = document.getElementById("timeField");
  const submitBtn = document.getElementById("submitBtn");

  const cityTimes = {  
    "Ù‚Ù†Ø§": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 9:00 ØµØ¨Ø§Ø­Ù‹Ø§"],  
    "Ø³ÙˆÙ‡Ø§Ø¬": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 1:00 Ø¸Ù‡Ø±Ù‹Ø§"],  
    "Ø£Ø³ÙŠÙˆØ·": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 1:00 Ø¸Ù‡Ø±Ù‹Ø§"],
    "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 ØµØ¨Ø§Ø­Ù‹Ø§"],
    "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 ØµØ¨Ø§Ø­Ù‹Ø§"],
    "Ø§Ù„ÙÙŠÙˆÙ…": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 ØµØ¨Ø§Ø­Ù‹Ø§"],
    "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 9:00 ØµØ¨Ø§Ø­Ù‹Ø§"],
    "Ø£Ø³ÙˆØ§Ù†": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 ØµØ¨Ø§Ø­Ù‹Ø§"],
    "Ø§Ù„Ø£Ù‚ØµØ±": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 9:00 ØµØ¨Ø§Ø­Ù‹Ø§"],
    "Ø§Ù„ØºØ±Ø¯Ù‚Ø©": ["Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 ØµØ¨Ø§Ø­Ù‹Ø§"]
  };

  function updateTimeField() {
    const city = cityEl.value;
    const grade = gradeEl.value;
    if (grade === "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ" && cityTimes[city]) {
      timeField.style.display = "block";
      timeField.innerHTML = `<option value="">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø©</option>` + cityTimes[city].map(time => `<option>${time}</option>`).join("");
    } else {
      timeField.style.display = "none";
      timeField.innerHTML = "";
    }
  }

  cityEl.addEventListener("change", updateTimeField);
  gradeEl.addEventListener("change", updateTimeField);

  function validateBasicFields() {
    const name = nameEl.value.trim();
    const nid = nidEl.value.trim();
    const phone = phoneEl.value.trim();
    const city = cityEl.value;
    const grade = gradeEl.value;
    if (!name || !nid || !phone || !city || !grade) return false;
    if (name.split(" ").length < 4) return false;
    if (!/^\d{14}$/.test(nid)) return false;
    if (!/^\d{11}$/.test(phone)) return false;
    return true;
  }

  function updateSubmitState() {
    submitBtn.disabled = !validateBasicFields();
  }

  [nameEl, nidEl, phoneEl, cityEl, gradeEl].forEach(el => {
    el.addEventListener("input", updateSubmitState);
    el.addEventListener("change", updateSubmitState);
  });

  submitBtn.addEventListener("click", async () => {
    if (!validateBasicFields()) {  
      alert("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");  
      return;  
    }

    submitBtn.disabled = true;
    submitBtn.classList.add("loading");
    submitBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯...";

    try {
      const name = nameEl.value.trim();
      const nid = nidEl.value.trim();
      const phone = phoneEl.value.trim();
      const city = cityEl.value;
      const grade = gradeEl.value;
      const time = timeField.value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

      if (grade === "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ") {
        window.location.href = "waiting.html";
        return;
      }

      const snapshot = await get(studentsRef);
      const data = snapshot.val() || {};
      const students = Object.values(data);

      const existingStudent = students.find(s => s.nationalId === nid);
      if (existingStudent) {
        alert(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…Ø­Ø§ÙØ¸Ø© (${existingStudent.city}) ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
        submitBtn.disabled = false;
        submitBtn.classList.remove("loading");
        submitBtn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²";
        return;
      }

      // --- ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (Ø§Ù„à¸¥à¸´Ù…à¸´à¸•) Ù…Ù† Ù‡Ù†Ø§ ---

      await set(push(studentsRef), {
        name,
        nationalId: nid,
        phone,
        city,
        grade,
        time,
        date: new Date().toISOString() // Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©
      });

      window.location.href = `confirm.html?name=${encodeURIComponent(name)}&nid=${encodeURIComponent(nid)}&city=${encodeURIComponent(city)}`;

    } catch (error) {
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø². Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      console.error(error);
      submitBtn.disabled = false;
      submitBtn.classList.remove("loading");
      submitBtn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²";
    }
  });

  updateSubmitState();
</script>

</body>
</html>